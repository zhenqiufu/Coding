

ref:https://wangpengcheng.github.io/2019/05/17/cplusplus_theadpool/

https://www.cnblogs.com/lzpong/p/6397997.html

## 基础概念

**线程池:** 当进行并行的任务作业操作时，线程的建立与销毁的开销是，阻碍性能进步的关键，因此线程池，由此产生。使用多个线程，无限制循环等待队列，进行计算和操作。帮助快速降低和减少性能损耗。

T1：线程创建时间
T2：线程执行时间，包括线程的同步等时间
T3：线程销毁时间

- 线程本身的开销所占的比例为(T1+T3) / (T1+T2+T3)
- 如果线程执行的时间很短的话，这比开销可能占到20%-50%左右。如果任务执行时间很长的话，这笔开销将是不可忽略的。
- 统方案中，如果同时请求数目为2000，那么最坏情况下，系统可能需要产生2000个线程。尽管这不是一个很大的数目，但是也有部分机器可能达不到这种要求。
- 线程池采用预创建的技术，在应用程序启动之后，将立即创建一定数量的线程(N1)，放入空闲队列中。这些线程都是处于阻塞（Suspended）状态，不消耗CPU，但占用较小的内存空间。当任务到来后，缓冲池选择一个空闲线程，把任务传入此线程中运行。当N1个线程都在处理任务后，缓冲池自动创建一定数量的新线程，用于处理更多的任务。在任务执行完毕后线程也不退出，而是继续保持在池中等待下一次的任务。当系统比较空闲时，大部分线程都一直处于暂停状态，线程池自动销毁一部分线程，回收系统资源。
- 线程池通常适合下面的几个场合：
  (1)单位时间内处理任务频繁而且任务处理时间短
  (2)对实时性要求较高。如果接受到任务后在创建线程，可能满足不了实时要求，因此必须采用线程池进行预创建。

## 线程池的组成

1. 线程池管理器：初始化和创建线程，启动和停止线程，调配任务；管理线程池
2. 工作线程：线程池中等待并执行分配的任务
3. 任务接口：添加任务的接口，以提供工作线程调度任务的执行。
4. 任务队列：用于存放没有处理的任务，提供一种缓冲机制，同时具有调度功能，高优先级的任务放在队列前面



## 线程池工作的四种情况

- **1. 没有任务要执行，缓冲队列为空**
<img src="https://img2018.cnblogs.com/blog/1384555/201811/1384555-20181125200244522-1220110086.png" alt="空队列情况" style="zoom:50%;" />

- **2. 队列中任务数量，小于等于线程池中线程任务数量**

<img src="https://img2018.cnblogs.com/blog/1384555/201811/1384555-20181125200256243-812341901.png" alt="任务数量小于线程数量" style="zoom: 50%;" />

- **3. 任务数量大于线程池数量,缓冲队列未满**

<img src="https://img2018.cnblogs.com/blog/1384555/201811/1384555-20181125200302734-327449131.png" alt="任务数量大于线程池数量" style="zoom:50%;" />

- **4. 任务数量大于线程池数量，缓冲队列已满**

<img src="https://img2018.cnblogs.com/blog/1384555/201811/1384555-20181125200310191-1172074659.png" alt="缓冲队列已满" style="zoom:50%;" />



## 线程池的C++实现